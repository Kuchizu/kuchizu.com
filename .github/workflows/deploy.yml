name: Deploy to Kubernetes

on:
  push:
    branches: [master]
    paths-ignore:
      - '*.md'
      - 'k8s/README.md'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - image: portfolio
            context: .
            file: docker/Dockerfile
          - image: portfolio-fetcher
            context: .
            file: docker/Dockerfile.fetcher
          - image: spotify-service
            context: services/spotify
            file: services/spotify/Dockerfile
          - image: steam-service
            context: services/steam
            file: services/steam/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.4
        env:
          GITHUB_TOKEN: ${{ secrets.DATA_GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          SERVERS: ${{ secrets.SERVERS }}
          IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GITHUB_TOKEN,STEAM_API_KEY,SPOTIFY_CLIENT_ID,SPOTIFY_CLIENT_SECRET,SPOTIFY_REFRESH_TOKEN,SERVERS,IMAGE_PREFIX
          script: |
            if [ ! -d "/root/kuchizu.com" ]; then
              git clone https://github.com/Kuchizu/kuchizu.com.git /root/kuchizu.com
            fi
            cd /root/kuchizu.com
            git fetch origin master
            git reset --hard origin/master
            git rev-parse --short HEAD > .commit

            # Update sitemap lastmod
            sed -i "s|<lastmod>.*</lastmod>|<lastmod>$(date +%Y-%m-%d)</lastmod>|" public/sitemap.xml

            # Pull images from GHCR
            sudo k3s crictl pull $IMAGE_PREFIX/portfolio:latest &
            sudo k3s crictl pull $IMAGE_PREFIX/portfolio-fetcher:latest &
            sudo k3s crictl pull $IMAGE_PREFIX/spotify-service:latest &
            sudo k3s crictl pull $IMAGE_PREFIX/steam-service:latest &
            wait

            # Apply k8s resources
            sudo kubectl apply -f k8s/pvc.yaml
            sudo kubectl delete secret portfolio-secrets -n kuchizu-portfolio 2>/dev/null || true
            sudo kubectl create secret generic portfolio-secrets -n kuchizu-portfolio \
              --from-literal=GITHUB_TOKEN="$GITHUB_TOKEN" \
              --from-literal=STEAM_API_KEY="$STEAM_API_KEY" \
              --from-literal=SPOTIFY_CLIENT_ID="$SPOTIFY_CLIENT_ID" \
              --from-literal=SPOTIFY_CLIENT_SECRET="$SPOTIFY_CLIENT_SECRET" \
              --from-literal=SPOTIFY_REFRESH_TOKEN="$SPOTIFY_REFRESH_TOKEN" \
              --from-literal=SERVERS="${SERVERS:-[]}"
            sudo kubectl apply -f k8s/

            # Restart all deployments
            sudo kubectl rollout restart deployment -n kuchizu-portfolio
            sudo kubectl rollout status deployment -n kuchizu-portfolio --timeout=120s

      - name: Purge Cloudflare Cache
        run: |
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: Send Telegram notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            EMOJI="✅"
            STATUS="deployed"
          else
            EMOJI="❌"
            STATUS="failed"
          fi

          MESSAGE="${EMOJI} <b>kuchizu.com</b> ${STATUS}

          <b>Commit:</b> <code>${{ github.sha }}</code>
          <b>Author:</b> ${{ github.actor }}
          <b>Message:</b> ${{ github.event.head_commit.message }}

          <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View logs</a>"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            -d text="$MESSAGE"
