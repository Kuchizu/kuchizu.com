name: Deploy to Kubernetes

on:
  push:
    branches: [master]
    paths-ignore:
      - '*.md'
      - 'k8s/README.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.DATA_GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          SERVERS: ${{ secrets.SERVERS }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GITHUB_TOKEN,STEAM_API_KEY,SPOTIFY_CLIENT_ID,SPOTIFY_CLIENT_SECRET,SPOTIFY_REFRESH_TOKEN,SERVERS
          script: |
            if [ ! -d "/root/kuchizu.com" ]; then
              git clone https://github.com/Kuchizu/kuchizu.com.git /root/kuchizu.com
            fi
            cd /root/kuchizu.com
            git fetch origin master
            git reset --hard origin/master
            git rev-parse --short HEAD > .commit

            # Update sitemap lastmod
            sed -i "s|<lastmod>.*</lastmod>|<lastmod>$(date +%Y-%m-%d)</lastmod>|" public/sitemap.xml

            # Build images
            docker build -f docker/Dockerfile -t kuchizu/portfolio:latest . &
            docker build -f docker/Dockerfile.fetcher -t kuchizu/portfolio-fetcher:latest . &
            docker build -t kuchizu/spotify-service:latest services/spotify/ &
            docker build -t kuchizu/steam-service:latest services/steam/ &
            wait

            # Import to k3s
            docker save kuchizu/portfolio:latest | sudo k3s ctr images import - &
            docker save kuchizu/portfolio-fetcher:latest | sudo k3s ctr images import - &
            docker save kuchizu/spotify-service:latest | sudo k3s ctr images import - &
            docker save kuchizu/steam-service:latest | sudo k3s ctr images import - &
            wait

            # Apply k8s resources
            sudo kubectl apply -f k8s/pvc.yaml
            sudo kubectl delete secret portfolio-secrets -n kuchizu-portfolio 2>/dev/null || true
            sudo kubectl create secret generic portfolio-secrets -n kuchizu-portfolio \
              --from-literal=GITHUB_TOKEN="$GITHUB_TOKEN" \
              --from-literal=STEAM_API_KEY="$STEAM_API_KEY" \
              --from-literal=SPOTIFY_CLIENT_ID="$SPOTIFY_CLIENT_ID" \
              --from-literal=SPOTIFY_CLIENT_SECRET="$SPOTIFY_CLIENT_SECRET" \
              --from-literal=SPOTIFY_REFRESH_TOKEN="$SPOTIFY_REFRESH_TOKEN" \
              --from-literal=SERVERS="${SERVERS:-[]}"
            sudo kubectl apply -f k8s/

            # Restart all deployments
            sudo kubectl rollout restart deployment -n kuchizu-portfolio
            sudo kubectl rollout status deployment -n kuchizu-portfolio --timeout=120s

      - name: Purge Cloudflare Cache
        run: |
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
